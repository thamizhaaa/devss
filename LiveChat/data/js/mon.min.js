function updateUsers(e){$.ajax({url:applicationPath+"modules/users/ajax/logged_users_details.php",type:"POST",data:{request_id:requestID,track_users:globalSettings.track_users},cache:!1,success:function(t){var s=JSON.parse(t);sessionStorage.setItem("ultimate_support_chat-jsSession--loggedUsersResults",t);for(var a in s.active_request_results)if(s.active_request_results.hasOwnProperty(a)){var r=s.active_request_results[a].name;"utc_client"==s.active_request_results[a].name&&(r="Anonymous");var i="Chat with "+r;if(void 0!=s.active_request_results[a].avatar&&"undefined"!=s.active_request_results[a].avatar&&""!=s.active_request_results[a].avatar)var n='<div class="imgHolder"><img src="'+dataServer+"config/themes/img/avatars/"+s.active_request_results[a].avatar+'"/></div>';else var n='<div class="imgHolder"><img src="'+dataServer+'config/themes/img/avatars/default.png"/></div>';var o='<div class="chat-about"><div class="chat-with">'+i+'</div><div class="chat-num-messages"></div></div>';$(".chat-header").html(n+o),""!=s.active_request_results[a].uri&&$("#path").html("<h5><b>PATH:</b></h5><div>"+s.active_request_results[a].uri+"</div>");var u=s.active_request_results[a].country_name;u+=""!=s.active_request_results[a].country_name&&"Undefined"!=s.active_request_results[a].country_name?'<img class="tip_tip" title="'+s.active_request_results[a].country_name+'" style="margin-top:-2px; margin-left:10px" src="'+dataServer+"/img/countries/"+s.active_request_results[a].country_code.toLocaleLowerCase()+'.png"/>':'<img class="tip_tip" title="" style="margin-top:-2px; margin-left:10px" src="'+dataServer+'/img/countries/earth.png"/>',$("#location").html("<h5><b>LOCATION:</b></h5><div>"+u+"</div>"),$("#browser").html("<h5><b>BROWSER:</b></h5><div>"+s.active_request_results[a].browser+"</div>"),$("#platform").html("<h5><b>PLATFORM:</b></h5><div>"+s.active_request_results[a].os+"</div>"),$("#screen").html("<h5><b>SCREEN:</b></h5><div>"+s.active_request_results[a].screen_size+"</div>"),$("#ip_address").html("<h5><b>IP ADDRESS:</b></h5><div>"+s.active_request_results[a].ip_address+"</div>"),$("#end_chat_btn").html('<br><br><input class="op_end_chat" type="button" value="END CHAT" onclick="operator_end_chat('+s.active_request_results[a].request_id+')"/>'),$(function(){$(".tip_tip").tipTip()}),$(function(){$(".tip_tip").tipTip({maxWidth:"auto",edgeOffset:10})})}0==s.all_users.length&&(sessionStorage.setItem("ultimate_support_chat-jsSession--currentRequestsCount",0),$("#chat_requests_count").html("")),activeOperators=[];for(a in s.all_users)if(s.all_users.hasOwnProperty(a)){if(activeOperators[a]=s.all_users[a].operator_name,$("#chat_requests_count").html(s.all_users.length),currentRequestsCount=s.all_users.length,1==e&&sessionStorage.setItem("ultimate_support_chat-jsSession--currentRequestsCount",currentRequestsCount),currentRequestsCount>sessionStorage.getItem("ultimate_support_chat-jsSession--currentRequestsCount")){sessionStorage.setItem("ultimate_support_chat-jsSession--currentRequestsCount",currentRequestsCount);var c=s.all_users[currentRequestsCount-1].name,l="";if(l=void 0!=s.all_users[currentRequestsCount-1].avatar&&"undefined"!=s.all_users[currentRequestsCount-1].avatar?dataServer+"config/themes/img/avatars/"+s.all_users[currentRequestsCount-1].avatar:dataServer+"config/themes/img/avatars/default.png","true"==globalSettings.admin_desktop_notifications&&desktopNotification(c,l),"true"==globalSettings.admin_incoming_chat_request_audio){var p=new Audio(dataServer+"audio/"+globalSettings.incoming_chat_audio+".mp3");p.play()}}if(currentRequestsCount<sessionStorage.getItem("ultimate_support_chat-jsSession--currentRequestsCount")&&sessionStorage.setItem("ultimate_support_chat-jsSession--currentRequestsCount",currentRequestsCount),currentRequestsCount==sessionStorage.getItem("ultimate_support_chat-jsSession--currentRequestsCount"),""!=s.all_users[a].transfer_request){var _=s.all_users[a].transfer_request.split("_"),d=_[1];d==operatorUserID&&requestTransferConfirmation(s.all_users[a].request_id)}}}})}function cleanupCron(){$.ajax({url:applicationPath+"modules/users/ajax/cleanup_cron.php",type:"POST",data:{},cache:!1,success:function(e){}})}function desktopNotification(e,t){if("utc_client"==e&&(e="Anonymous"),"Notification"in window)if("granted"===Notification.permission){var s={title:"Ultimate Support Chat",body:"Chat request by "+e,icon:t,dir:"ltr"};new Notification("Ultimate Support Chat",s)}else"denied"!==Notification.permission&&Notification.requestPermission(function(s){if("permission"in Notification||(Notification.permission=s),"granted"===s){var a={title:"Ultimate Support Chat",body:"Chat request by "+e,icon:t,dir:"ltr"};new Notification("Ultimate Support Chat",a)}});else alert("This browser does not support desktop notification")}function loadSidePanel(){$(".control-sidebar").hasClass("control-sidebar-open")&&$.ajax({url:applicationPath+"modules/settings/ajax/side_panel.php",type:"POST",data:{},cache:!1,success:function(e){var t=JSON.parse(e),s="",a="";for(var r in t.prepared_messages)t.prepared_messages.hasOwnProperty(r)&&("settings"==smartyModule&&"prepared_messages"==smartyController&&(a='<span class="prep_msg_del"  style="float:right" onclick="deletePrepMsg('+t.prepared_messages[r].id+')"><i class="fa fa-trash"></i></span>'),s+='<p style="cursor:pointer; display: list-item; margin-left: 10px;" id="prep_msg_'+t.prepared_messages[r].id+'" onclick="appendPrepMsg('+t.prepared_messages[r].id+')">'+t.prepared_messages[r].message+" "+a+"</p>");$("#prepared_msg").html(s);var i="";for(r in t.operators_online)if(t.operators_online.hasOwnProperty(r)){var n=t.operators_online[r].username,o="";o=void 0!=t.operators_online[r].avatar&&"undefined"!=t.operators_online[r].avatar&&""!=t.operators_online[r].avatar?dataServer+t.operators_online[r].avatar:dataServer+"config/themes/img/avatars/default.png",n=n.toLowerCase().replace(/\b[a-z]/g,function(e){return e.toUpperCase()}),i+='<li onclick="transferChatRequest('+t.operators_online[r].user_id+",'"+t.operators_online[r].username+"','"+t.operators_online[r].avatar+'\')"><a href="javascript:void(0);"><div style="float:left"><img src="'+o+'" style="width:30px; height:30px"/></div><div class="menu-info"><h4 class="control-sidebar-subheading">'+n+"</h4><p>"+(activeOperators.indexOf(t.operators_online[r].username)>-1==1?"In chat":"")+"</p></div></a></li>"}$("#operators_online").html(i)}})}function appendPrepMsg(e){var t=$("textarea#operator-message"),s=t.val(),a=$("#prep_msg_"+e).html();t.val(s+" "+a)}function transferChatRequest(e,t){var s=operatorUserID+"_"+e;if("visitors"!=smartyModule||"chat"!=smartyController)return!1;var a=confirm("Transfer chat to "+t+" ?");1==a&&$.ajax({url:applicationPath+"modules/users/ajax/operator_actions.php",type:"POST",data:{from_to:s,request_id:requestID,transfer:"request"},cache:!1,success:function(e){""!=e&&alert("Transfer request sent. Transfer will complete when operator "+t+" accepts the chat.")}})}function requestTransferConfirmation(e){var t=!1;"accepted"!=transferAccepted&&(t=confirm("You have a chat transfer request. Accept?")),t===!0&&(window.alert=function(){},$.ajax({url:applicationPath+"modules/users/ajax/operator_actions.php",type:"POST",data:{request_id:e,transfer:"true"},cache:!1,success:function(t){validNavigation=!0,window.location.href=applicationPath+"visitors/chat?request="+e+"&transfer=accepted",$("#chat_history").append(t)}}))}var currentRequestsCount="",activeOperators=[];updateUsers(!0),setInterval(function(){updateUsers(!1)},2500),cleanupCron(),setInterval(function(){cleanupCron()},6e5);