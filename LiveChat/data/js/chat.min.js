function updateVisitors(){var e=sessionStorage.getItem("ultimate_support_chat-jsSession--loggedUsersResults"),a=JSON.parse(e),s="";for(var t in a.all_users)if(a.all_users.hasOwnProperty(t)){imgHolder=void 0!=a.all_users[t].avatar&&"undefined"!=a.all_users[t].avatar&&""!=a.all_users[t].avatar?'<span class="imgHolder"><img src="'+dataServer+"config/themes/img/avatars/"+a.all_users[t].avatar+'"/></span>':'<span class="imgHolder"><img src="'+dataServer+'config/themes/img/avatars/default.png"/></span>';var r;void 0!=a.all_users[t].name&&(r=a.all_users[t].name),"utc_client"==a.all_users[t].name&&(r="Anonymous");var i='<span class="nameHolder">'+r+"</span>";s+='<div style="cursor:pointer" onclick="loadChat('+a.all_users[t].request_id+')">'+imgHolder+i+"</a></div><br/>"}$("#visitor_list").html(s),""==requestID&&a.all_users.length>0&&(window.location.href=applicationPath+"visitors/chat?request="+a.all_users[0].request_id)}function refreshChat(e){$.ajax({url:applicationPath+"modules/users/ajax/admin_log.php",type:"POST",data:{request_id:requestID},cache:!1,success:function(a){var s=JSON.parse(a),t="";"1"==s.user_typing&&(t='<div class="is_typing">User is typing...</div>'),currentNumRows=s.rows.length;var r="",i="";for(var o in s.rows)s.rows.hasOwnProperty(o)&&(i+=s.rows[o],r=o);var n="</terminate>";if(i.indexOf(n)>-1==1&&($("#operator-message").prop("disabled",!0),$(".op_end_chat").prop("disabled",!0),$(".op_end_chat").val("TERMINATED")),1==e&&sessionStorage.setItem("ultimate_support_chat-jsSession--adminLogResults",currentNumRows),currentNumRows>sessionStorage.getItem("ultimate_support_chat-jsSession--adminLogResults")&&(sessionStorage.setItem("ultimate_support_chat-jsSession--adminLogResults",currentNumRows),0==s.operator_id[r])){var u="1";void 0!=jsThemeConfig.adminMessageAudio&&(u=jsThemeConfig.adminMessageAudio);var l=new Audio(dataServer+"audio/"+u+".mp3");l.play()}var d='<div class="last_row_spacer">&nbsp;</div>';$("#chat_history").html(i+d+t),refreshLayout();var p=document.getElementById("chat_history");p.scrollTop=p.scrollHeight}})}function loadChat(e){validNavigation=!0,window.location.href=applicationPath+"visitors/chat?request="+e}function refreshLayout(){$(".u_reply").addClass("theme4"),$(".u_2").addClass("user_name"),$(".u_3").addClass("user_time"),$(".u_4").addClass("user_msg left_msg_bubble"),$(".a_reply").addClass("theme4"),$(".a_2").addClass("admin_name"),$(".a_3").addClass("admin_time"),$(".a_4").addClass("admin_msg right_msg_bubble")}function submitMessage(){var e=$("#operator-message"),a=e.val();return a.replace(/\s/g,"").length?($.ajax({url:applicationPath+"modules/users/ajax/operator_actions.php",type:"POST",data:{operatorMsg:a,currentRequestID:requestID,status:"0"},cache:!1,success:function(e){refreshChat(!1)}}),void e.val("")):(e.val(""),!1)}function userTypingStart(e){1==e&&updateStatus(1),startTyping=0}function userTypingDone(){updateStatus(0)}function updateStatus(e){$.ajax({url:applicationPath+"modules/users/ajax/operator_actions.php",type:"POST",data:{currentRequestID:requestID,status:e},cache:!1,success:function(e){}})}function operator_end_chat(e){var a=confirm("Terminate chat?");a===!0&&$.ajax({url:applicationPath+"modules/users/ajax/operator_actions.php",type:"POST",data:{request_id:e,terminate_chat:"true"},cache:!1,success:function(e){}})}var imgHolder;updateVisitors(),setInterval(updateVisitors,2500);var currentNumRows="",prevNumRows="",html="";""!=chatLoaded&&(refreshChat(!0),setInterval(refreshChat,2500)),$("#operator-submit-message").click(function(){return submitMessage(),!1});var startTyping=0,typingTimeout;document.getElementById("operator-message").addEventListener("keyup",function(e){e.preventDefault(),0==startTyping&&userTypingStart(!0,requestID),clearTimeout(startTyping),startTyping=setTimeout(function(){userTypingStart(!1)},2500),void 0!=typingTimeout&&clearTimeout(typingTimeout),typingTimeout=setTimeout(function(){userTypingDone(requestID)},2500);var a=e.keyCode?e.keyCode:e.which;13==a&&submitMessage()});